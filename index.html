<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, theme-color=#4f46e5">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tabungan">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Tabungan Bersama</title>
    
    <link rel="manifest" id="manifest-link">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2830/2830284.png">

    <!-- Tailwind CSS with Dark Mode Support -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        premium: '#4f46e5',
                        'premium-dark': '#3b82f6',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; } 
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; overflow-x: hidden; }
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .bg-premium-gradient { background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); }
        .celeb-ping { animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite; }
        .toast-visible { opacity: 1 !important; transform: translate(-50%, -20px) !important; }
        
        /* Spinner */
        .spinner { animation: rotate 2s linear infinite; width: 1.25rem; height: 1.25rem; display: inline-block; vertical-align: middle; }
        .spinner .path { stroke: currentColor; stroke-linecap: round; animation: dash 1.5s ease-in-out infinite; }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        @keyframes dash { 0% { stroke-dasharray: 1, 150; stroke-dashoffset: 0; } 50% { stroke-dasharray: 90, 150; stroke-dashoffset: -35; } 100% { stroke-dasharray: 90, 150; stroke-dashoffset: -124; } }
        
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        
        /* Modal selection style */
        .color-btn.selected { border-color: #1e293b; transform: scale(1.1); border-width: 4px; }
        .dark .color-btn.selected { border-color: #ffffff; }
        .emoji-btn.selected { border-color: #4f46e5; background-color: #eef2ff; transform: scale(1.1); border-width: 2px; }
        .dark .emoji-btn.selected { background-color: #312e81; }

        /* Bubble Chat Style */
        .chat-bubble-me { border-bottom-right-radius: 4px; background: #4f46e5; color: white; margin-left: 20%; }
        .chat-bubble-other { border-bottom-left-radius: 4px; background: #f1f5f9; color: #1e293b; margin-right: 20%; }
        .dark .chat-bubble-other { background: #1e293b; color: #f8fafc; }
        
        .reaction-pop { animation: bounce 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.4); } }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-950 transition-colors duration-300">

    <div class="app-container flex flex-col h-screen relative bg-slate-50 dark:bg-slate-900 shadow-2xl">
        
        <!-- SPLASH SCREEN -->
        <div id="splash-screen" class="fixed inset-0 z-[100] bg-slate-50 dark:bg-slate-950 flex flex-col items-center justify-center transition-opacity duration-700 max-w-[480px] mx-auto text-center">
            <div class="w-28 h-28 bg-white dark:bg-slate-800 rounded-[2rem] flex items-center justify-center mb-8 shadow-2xl shadow-indigo-500/20 animate-bounce mx-auto">
                <img src="https://cdn-icons-png.flaticon.com/512/2830/2830284.png" alt="Logo" class="w-16 h-16">
            </div>
            <h1 class="text-3xl font-black text-slate-900 dark:text-white tracking-tighter">Tabungan Bersama</h1>
            <p class="text-xs font-bold text-slate-400 mt-2 tracking-widest uppercase">Memuat Data...</p>
        </div>

        <!-- REALTIME NOTIFICATION TOAST -->
        <div id="realtime-notif" class="fixed top-0 left-1/2 transform -translate-x-1/2 -translate-y-full w-[90%] max-w-[400px] bg-indigo-600 text-white p-4 rounded-2xl shadow-2xl z-[110] flex items-start gap-3 transition-transform duration-300 cursor-pointer" onclick="this.classList.add('-translate-y-full')">
            <div class="bg-white/20 p-2 rounded-full shrink-0"><i data-lucide="bell-ring" class="w-5 h-5 text-white animate-pulse"></i></div>
            <div class="flex-1 pr-2 text-left">
                <p class="text-[10px] font-bold text-indigo-200 uppercase tracking-widest mb-0.5" data-t="notif_title">Aktivitas Baru!</p>
                <p id="realtime-notif-text" class="text-sm font-black leading-tight"></p>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 translate-y-4 bg-slate-900 dark:bg-slate-800 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl opacity-0 transition-all duration-300 z-[100] whitespace-nowrap pointer-events-none">
            Pesan
        </div>

        <!-- VIEW 1: HOME -->
        <main id="view-home" class="flex-1 overflow-y-auto no-scrollbar pb-24 hidden">
            <div class="px-6 pt-10 pb-4 bg-white dark:bg-slate-900 relative">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4 text-left">
                        <div id="home-avatar" class="w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold shadow-inner transition-all duration-500"></div>
                        <div>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider translate-y-0.5" data-t="welcome">Selamat datang,</p>
                            <p id="home-username" class="font-extrabold text-slate-900 dark:text-white text-lg tracking-tight">-</p>
                        </div>
                    </div>
                    <div id="auth-status-icon" class="text-emerald-500 opacity-50"><i data-lucide="shield-check" class="w-5 h-5"></i></div>
                </div>
            </div>

            <div class="px-6 pb-4 bg-white dark:bg-slate-900 rounded-b-[2.5rem] shadow-sm border-b border-slate-100 dark:border-slate-800 text-left">
                <!-- Total Balance Card -->
                <div class="bg-premium-gradient rounded-[2rem] p-7 shadow-xl shadow-indigo-200/40 dark:shadow-none text-white relative overflow-hidden text-left mb-6">
                    <div class="relative z-10 flex justify-between items-center mb-1">
                        <p class="text-indigo-100 font-medium text-xs opacity-80 uppercase tracking-widest" data-t="total_balance">Total Saldo</p>
                        <button onclick="window.toggleBalance()" class="p-2 bg-white/10 rounded-full active:scale-95 transition-transform">
                            <i id="eye-icon" data-lucide="eye" class="w-4 h-4 text-white"></i>
                        </button>
                    </div>
                    <h1 id="total-balance" class="text-4xl font-black tracking-tight mb-6" data-value="0">Rp 0</h1>
                    
                    <div class="relative z-10 pt-5 border-t border-white/10 flex justify-between items-center">
                        <div>
                            <p id="label-income" class="text-[9px] uppercase font-black text-indigo-200 mb-1 tracking-tighter">Masuk</p>
                            <p id="mutasi-in" class="font-bold text-sm text-emerald-300" data-value="0">Rp 0</p>
                        </div>
                        <div class="w-px h-6 bg-white/10"></div>
                        <div class="text-right">
                            <p id="label-outcome" class="text-[9px] uppercase font-black text-indigo-200 mb-1 tracking-tighter">Keluar</p>
                            <p id="mutasi-out" class="font-bold text-sm text-rose-300" data-value="0">Rp 0</p>
                        </div>
                    </div>
                </div>

                <!-- DANA Style Feed Updates (Optimized non-truncated) -->
                <div class="bg-white dark:bg-slate-800 rounded-3xl p-5 shadow-sm border border-slate-100 dark:border-slate-700 text-left">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="p-1.5 bg-rose-100 dark:bg-rose-900/30 text-rose-500 rounded-lg"><i data-lucide="megaphone" class="w-4 h-4"></i></div>
                        <h3 class="text-[10px] font-black text-slate-500 dark:text-slate-400 uppercase tracking-widest">Updates Teman</h3>
                    </div>
                    <div id="home-updates-feed" class="space-y-4 max-h-40 overflow-y-auto no-scrollbar relative text-left">
                        <p class="text-[10px] text-slate-400 italic">Belum ada aktivitas terbaru...</p>
                    </div>
                </div>
            </div>

            <div class="p-6 text-left">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-black text-slate-900 dark:text-white tracking-tight" data-t="savings_goal">Tujuan Tabungan</h2>
                    <button onclick="window.switchView('view-create')" class="bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 p-2 rounded-full active:scale-90 transition-transform">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="rooms-container" class="space-y-4"></div>
            </div>
        </main>

        <!-- VIEW 2: DETAIL ROOM -->
        <main id="view-detail" class="flex-1 overflow-y-auto no-scrollbar pb-32 bg-slate-50 dark:bg-slate-950 hidden relative flex flex-col h-full text-left">
            <div class="sticky top-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md z-10 px-5 py-4 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="window.historyBackOverride('view-home')" class="p-2 text-slate-600 dark:text-slate-400 active:scale-90"><i data-lucide="chevron-left" class="w-7 h-7"></i></button>
                    <h1 id="detail-title" class="font-bold text-lg text-slate-800 dark:text-white truncate max-w-[150px]">Detail</h1>
                </div>
                
                <!-- Member Pile -->
                <div id="detail-member-pile" class="flex -space-x-2 overflow-hidden mr-2">
                    <!-- Avatars Injected Here -->
                </div>

                <button onclick="window.openEditModal()" class="p-2 text-slate-400 hover:text-indigo-500 transition-colors"><i data-lucide="edit-2" class="w-5 h-5"></i></button>
            </div>

            <div class="p-8 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 text-center shrink-0">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2" data-t="available_balance">Saldo Tersedia</p>
                <h2 id="detail-balance" class="text-4xl font-black text-slate-900 dark:text-white tracking-tight">Rp 0</h2>
                
                <div id="detail-target-container" class="mt-8 bg-slate-50 dark:bg-slate-800/50 p-5 rounded-3xl text-left hidden border border-slate-100 dark:border-slate-800">
                    <div class="flex justify-between text-xs font-bold mb-3">
                        <span class="text-slate-400 uppercase" data-t="progress">Progres</span>
                        <span id="detail-progress-text" class="text-indigo-600 dark:text-indigo-400">0 / 0</span>
                    </div>
                    <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-3 overflow-hidden">
                        <div id="detail-progress-bar" class="bg-indigo-600 h-3 transition-all duration-1000 shadow-sm" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Detail Tabs (Social Logic) -->
            <div class="flex bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 shrink-0">
                <button onclick="window.switchDetailTab('history')" id="tab-btn-history" class="flex-1 py-4 text-xs font-black text-indigo-600 border-b-2 border-indigo-600 transition-colors uppercase tracking-widest" data-t="history_tab">Riwayat</button>
                <button onclick="window.switchDetailTab('chat')" id="tab-btn-chat" class="flex-1 py-4 text-xs font-bold text-slate-400 border-b-2 border-transparent transition-colors uppercase tracking-widest flex items-center justify-center gap-2">Diskusi <i data-lucide="message-circle" class="w-3.5 h-3.5"></i></button>
            </div>

            <!-- Tab Content: History -->
            <div id="tab-content-history" class="flex-1 overflow-y-auto no-scrollbar p-6 text-left">
                <div id="detail-history-list" class="relative border-l-2 border-indigo-100 dark:border-indigo-900/30 ml-3 space-y-8 pb-4"></div>
            </div>

            <!-- Tab Content: Chat -->
            <div id="tab-content-chat" class="flex-1 hidden bg-slate-50 dark:bg-slate-950 p-4 pb-24 overflow-y-auto no-scrollbar flex flex-col">
                <div id="chat-list" class="space-y-4 flex-1 mb-4 flex flex-col justify-end text-left">
                    <!-- Chat bubbles injected here -->
                </div>
            </div>

            <!-- Action Bar (Sticky Bottom) -->
            <div id="action-bar-history" class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 max-w-[480px] mx-auto z-20 flex gap-4">
                <button onclick="window.openTransactionModal('tarik')" class="flex-1 py-4 bg-rose-50 dark:bg-rose-900/20 text-rose-600 dark:text-rose-400 font-black rounded-2xl active:bg-rose-100" data-t="withdraw">Tarik</button>
                <button onclick="window.openTransactionModal('nabung')" class="flex-1 py-4 bg-premium text-white font-black rounded-2xl shadow-xl shadow-indigo-200 dark:shadow-none active:opacity-90" data-t="save">Nabung</button>
            </div>

            <div id="action-bar-chat" class="fixed bottom-0 left-0 right-0 p-4 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 max-w-[480px] mx-auto z-20 hidden text-left">
                <form id="chat-form" onsubmit="window.handleSendChat(event)" class="flex items-center gap-2 relative">
                    <input type="text" id="chat-input" class="flex-1 bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white text-sm font-bold rounded-full py-3 px-5 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ketik pesan..." autocomplete="off">
                    <button type="submit" class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white shrink-0 active:scale-90 transition-transform"><i data-lucide="send" class="w-5 h-5 ml-1"></i></button>
                </form>
            </div>
        </main>

        <!-- VIEW 3: GLOBAL HISTORY -->
        <main id="view-history" class="flex-1 overflow-y-auto no-scrollbar pb-24 bg-white dark:bg-slate-900 hidden text-left">
            <div class="px-6 pt-10 pb-4 border-b border-slate-100 dark:border-slate-800 sticky top-0 bg-white dark:bg-slate-900 z-10 text-left">
                <h1 class="text-2xl font-black text-slate-900 dark:text-white mb-5 tracking-tight" data-t="history">Riwayat</h1>
                
                <div class="flex items-center justify-between gap-2">
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1 text-left">
                        <button onclick="window.filterHistory('all')" id="filter-all" class="px-5 py-2 bg-slate-900 dark:bg-indigo-600 text-white text-xs font-black rounded-full whitespace-nowrap" data-t="all">Semua</button>
                        <button onclick="window.filterHistory('in')" id="filter-in" class="px-5 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-black rounded-full whitespace-nowrap" data-t="in">Masuk</button>
                        <button onclick="window.filterHistory('out')" id="filter-out" class="px-5 py-2 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-black rounded-full whitespace-nowrap" data-t="out">Keluar</button>
                    </div>
                    
                    <select id="time-filter" onchange="window.changeTimeFilter(this.value)" class="bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-[10px] font-black rounded-xl px-2 py-2 outline-none uppercase shrink-0">
                        <option value="all_time" data-t="filter_all_time">Semua</option>
                        <option value="this_month" data-t="filter_this_month">Bulan Ini</option>
                        <option value="last_month" data-t="filter_last_month">Bulan Lalu</option>
                    </select>
                </div>
            </div>
            <div id="global-history-container" class="p-6 space-y-4"></div>
        </main>

        <!-- VIEW 4: PROFILE -->
        <main id="view-profile" class="flex-1 overflow-y-auto no-scrollbar pb-24 bg-slate-50 dark:bg-slate-950 hidden text-center">
            <div class="p-10 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 relative">
                <div class="relative inline-block mx-auto mb-5">
                    <div id="profile-avatar" class="w-24 h-24 rounded-full flex justify-center items-center text-5xl font-black border border-black/5 shadow-inner"></div>
                    <button onclick="window.openAvatarModal()" class="absolute bottom-0 right-0 bg-slate-900 dark:bg-slate-700 text-white p-2.5 rounded-full border-4 border-white dark:border-slate-900 shadow-md active:scale-90 transition-transform">
                        <i data-lucide="pencil" class="w-4 h-4"></i>
                    </button>
                </div>
                <h1 id="profile-username" class="text-2xl font-black text-slate-900 dark:text-white tracking-tight">-</h1>
                <p id="profile-email" class="text-[10px] font-bold text-slate-400 mt-1 mb-2"></p>
                <p id="profile-stats" class="text-xs font-bold text-indigo-500 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 inline-block px-4 py-1.5 rounded-full">0 Tabungan Aktif</p>
            </div>

            <div class="p-6 space-y-8 text-left">
                <div>
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] px-2 mb-4" data-t="data_activities">Data & Aktivitas</h3>
                    <div class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm">
                        <div onclick="window.switchView('view-archive')" class="flex items-center justify-between p-5 cursor-pointer active:bg-slate-50 dark:active:bg-slate-800 transition-colors border-b border-slate-100 dark:border-slate-800">
                            <div class="flex items-center gap-4">
                                <div class="p-2.5 bg-amber-50 dark:bg-amber-900/20 text-amber-500 rounded-xl"><i data-lucide="archive" class="w-5 h-5"></i></div>
                                <div>
                                    <p class="text-sm font-black text-slate-700 dark:text-slate-200 tracking-tight" data-t="archive">Arsip Tabungan</p>
                                    <p class="text-[10px] font-bold text-slate-400 uppercase" data-t="archive_desc">Target Selesai 100%</p>
                                </div>
                            </div>
                            <i data-lucide="chevron-right" class="text-slate-300 w-5 h-5"></i>
                        </div>
                        
                        <div onclick="window.logoutGoogle()" class="flex items-center justify-between p-5 cursor-pointer active:bg-rose-50 dark:active:bg-rose-900/20 transition-colors">
                            <div class="flex items-center gap-4 text-left">
                                <div class="p-2.5 bg-rose-50 dark:bg-rose-900/20 text-rose-500 rounded-xl"><i data-lucide="log-out" class="w-5 h-5"></i></div>
                                <span class="text-sm font-black text-rose-600 dark:text-rose-400" data-t="logout">Keluar (Logout)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- FOOTER NAV -->
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 px-6 py-3 flex justify-between items-center z-10 pb-safe hidden">
            <button onclick="window.switchView('view-home', 'nav-home')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-indigo-600 transition-all" id="nav-home">
                <i data-lucide="home" class="w-6 h-6"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter" data-t="nav_home">Home</span>
            </button>
            <button onclick="window.switchView('view-history', 'nav-history')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-300 transition-all" id="nav-history">
                <i data-lucide="pie-chart" class="w-6 h-6"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter" data-t="nav_history">Riwayat</span>
            </button>
            <button onclick="window.switchView('view-profile', 'nav-profile')" class="nav-btn flex-1 flex flex-col items-center gap-1 text-slate-300 transition-all" id="nav-profile">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter" data-t="nav_profile">Profil</span>
            </button>
        </nav>

        <!-- OVERLAY MODALS -->
        <div id="modal-overlay" class="fixed inset-0 bg-slate-900/50 dark:bg-slate-950/80 backdrop-blur-sm z-[50] hidden transition-opacity" onclick="window.closeAllModals()"></div>

        <!-- ONBOARDING -->
        <div id="modal-onboarding" class="fixed inset-0 z-[60] flex items-center justify-center p-8 bg-white dark:bg-slate-900 max-w-[480px] mx-auto transition-opacity duration-500 hidden opacity-0 text-center">
            <div class="w-full text-center">
                <div class="w-28 h-28 bg-indigo-50 dark:bg-indigo-900/30 rounded-full mx-auto flex items-center justify-center mb-10 shadow-inner border border-indigo-100 dark:border-indigo-900/30">
                    <img src="https://cdn-icons-png.flaticon.com/512/2830/2830284.png" alt="Logo" class="w-16 h-16 mx-auto">
                </div>
                <h2 class="text-3xl font-black text-slate-900 dark:text-white mb-3 tracking-tighter">Tabungan Bersama</h2>
                <p class="text-sm font-bold text-slate-500 dark:text-slate-400 mb-10 text-center" data-t="login_desc">Simpan data tabungan Anda dengan aman di awan menggunakan akun Google.</p>
                
                <button id="btn-google-login" onclick="window.loginWithGoogle()" class="w-full py-4 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-white font-black text-lg rounded-[1.5rem] shadow-sm flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <svg viewBox="0 0 24 24" class="w-6 h-6"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path fill="none" d="M1 1h22v22H1z"/></svg>
                    <span data-t="login_google">Masuk dengan Google</span>
                </button>
            </div>
        </div>

        <!-- NAME ENTRY -->
        <div id="modal-name-entry" class="fixed inset-0 z-[60] flex items-center justify-center p-8 hidden bg-white dark:bg-slate-900 max-w-[480px] mx-auto transition-opacity duration-500 opacity-0 text-left">
            <div class="w-full text-center">
                <div class="w-28 h-28 bg-indigo-50 dark:bg-indigo-900/30 rounded-full mx-auto flex items-center justify-center mb-10 shadow-inner border border-indigo-100 dark:border-indigo-900/30">
                    <img src="https://cdn-icons-png.flaticon.com/512/2830/2830284.png" alt="Logo" class="w-16 h-16 mx-auto">
                </div>
                <h2 class="text-3xl font-black text-slate-900 dark:text-white mb-8 tracking-tighter text-center">Konfirmasi Profil</h2>
                <div class="text-left mb-8 relative">
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 px-1">Nama Tampilan</label>
                    <input type="text" id="onboarding-name" placeholder="Contoh: Leonardo Suprayogi" class="w-full p-5 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-800 rounded-[1.25rem] font-bold text-xl outline-none focus:ring-4 focus:ring-indigo-500/10 transition-all text-slate-900 dark:text-white">
                    <p class="text-[10px] text-rose-500 font-bold mt-3 px-2 flex items-start gap-1.5 leading-tight">
                        <i data-lucide="info" class="w-3.5 h-3.5 shrink-0"></i>
                        <span data-t="name_warning">*Peringatan: Nama tidak dapat diubah setelah disimpan. Mohon gunakan nama asli Anda.</span>
                    </p>
                </div>
                <button id="btn-save-name" onclick="window.saveOnboardingName()" class="w-full py-5 bg-premium text-white font-black text-lg rounded-[1.5rem] shadow-xl">Simpan Profil & Masuk</button>
            </div>
        </div>

        <!-- MODAL AVATAR -->
        <div id="modal-avatar" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white dark:bg-slate-900 rounded-t-[2.5rem] z-[55] transform translate-y-full transition-transform duration-300 shadow-2xl hidden flex flex-col max-h-[80vh] text-left">
            <div class="p-8 pb-4 flex justify-between items-center border-b border-slate-100 dark:border-slate-800">
                <h3 class="font-black text-xl text-slate-900 dark:text-white text-left" data-t="choose_avatar">Pilih Avatar</h3>
                <button onclick="window.closeAllModals()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full active:scale-90 transition-transform"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
            </div>
            <div class="p-8 overflow-y-auto no-scrollbar flex-1 text-left">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 text-left">Warna Latar</p>
                <div id="color-options" class="flex gap-4 overflow-x-auto no-scrollbar pb-4 mb-6"></div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 text-left">Emoji Ikon</p>
                <div id="emoji-options" class="grid grid-cols-5 gap-4"></div>
            </div>
            <div class="p-6 border-t border-slate-100 dark:border-slate-800">
                <button onclick="window.saveAvatarSelection()" class="w-full py-4 bg-slate-900 dark:bg-indigo-600 text-white font-black rounded-[1.25rem] shadow-lg active:scale-95 transition-all" data-t="save_changes">Simpan</button>
            </div>
        </div>

        <!-- MODAL EDIT -->
        <div id="modal-edit" class="fixed bottom-0 left-0 right-0 max-w-[480px] mx-auto bg-white dark:bg-slate-900 rounded-t-[2.5rem] z-[55] transform translate-y-full transition-transform duration-300 shadow-2xl hidden text-left">
            <div class="p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="font-black text-2xl text-slate-900 dark:text-white" data-t="edit_goal">Ubah Tabungan</h3>
                    <button onclick="window.closeAllModals()" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full active:scale-90 transition-transform"><i data-lucide="x" class="w-5 h-5 text-slate-500"></i></button>
                </div>
                <div class="space-y-6 mb-10">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-t="goal_name">Nama Tujuan</label>
                        <input type="text" id="edit-name" class="w-full p-5 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-800 rounded-2xl font-bold text-slate-900 dark:text-white outline-none">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-t="target_nominal">Target Nominal</label>
                        <div class="relative">
                            <span class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 font-bold">Rp</span>
                            <input type="text" id="edit-target" inputmode="numeric" class="money-input w-full p-5 pl-14 bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-800 rounded-2xl font-bold text-slate-900 dark:text-white outline-none">
                        </div>
                    </div>
                </div>
                <button id="btn-save-edit" onclick="window.handleEditSubmit()" class="w-full py-5 bg-premium text-white font-black text-lg rounded-[1.5rem] shadow-xl flex items-center justify-center gap-3" data-t="save_changes">Simpan Perubahan</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // --- GLOBAL CONSTANTS & FIREBASE CONFIG ---
        const DB_KEY = 'tabungan_app_v10_stable';
        const modalIds = ['modal-transaction', 'modal-manage', 'modal-share', 'modal-avatar', 'modal-celebration', 'modal-edit', 'modal-install', 'modal-name-entry'];

        const firebaseConfig = {
            apiKey: "AIzaSyDUPTlI50-ZrTwokK9A9S7MJr5iCmqqyT4",
            authDomain: "tabungan-bersama-e48da.firebaseapp.com",
            projectId: "tabungan-bersama-e48da",
            storageBucket: "tabungan-bersama-e48da.firebasestorage.app",
            messagingSenderId: "984749032676",
            appId: "1:984749032676:web:eee0cff2200445e927d8f1"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- TRANSLATIONS ---
        const i18n = {
            id: {
                welcome: "Selamat datang,", total_balance: "Total Saldo", income: "Masuk", outcome: "Keluar",
                savings_goal: "Tujuan Tabungan", available_balance: "Saldo Tersedia", progress: "Progres Keseluruhan",
                archive_now: "Arsipkan Sekarang", history: "Riwayat Transaksi", history_tab: "Riwayat", chat_tab: "Diskusi",
                withdraw: "Tarik", save: "Nabung", nav_home: "Beranda", nav_history: "Riwayat", nav_profile: "Profil",
                archive: "Arsip Tabungan", archive_desc: "Target 100% Selesai", dark_mode: "Mode Gelap", language_name: "Bahasa",
                language_val: "ID", edit_goal: "Ubah Tabungan", goal_name: "Nama Tujuan", target_nominal: "Target Nominal",
                save_changes: "Simpan Perubahan", goal_reached: "Tercapai!", celeb_desc: "Tabungan", celeb_done: "lunas 100%!",
                continue: "Lanjutkan", label_depositor: "Penyetor", label_note: "Catatan (Opsional)", confirm: "Konfirmasi",
                all: "Semua", in: "Masuk", out: "Keluar", data_activities: "Data & Aktivitas", app_settings: "Pengaturan Aplikasi",
                no_goals: "Belum ada tabungan", no_archive: "Belum ada arsip", empty_history: "Belum ada riwayat",
                placeholder_goal: "Beli Laptop...", install_app: "Install Aplikasi",
                choose_avatar: "Pilih Avatar", options: "Opsi", share: "Bagikan", delete: "Hapus Tabungan",
                share_title: "Undang Teman",
                install_ios_desc: "Untuk pengguna iPhone/iPad (Safari):", install_ios_step1: "Tekan ikon Bagikan di bawah", install_ios_step2: "Pilih 'Tambah ke Layar Utama'",
                install_android_desc: "Untuk pengguna Android (Chrome):", install_android_step1: "Tekan ikon Titik Tiga di atas", install_android_step2: "Pilih 'Tambahkan ke Layar Utama'",
                install_prompt_title: "Install Aplikasi", install_prompt_desc: "Akses lebih cepat & mudah", install_btn: "Lihat Tutorial",
                login_desc: "Simpan data tabungan Anda dengan aman di awan menggunakan akun Google.", login_google: "Masuk dengan Google", logout: "Keluar (Logout)",
                name_warning: "*Peringatan: Nama tidak dapat diubah setelah disimpan. Mohon gunakan nama asli Anda.",
                filter_all_time: "Semua Waktu", filter_this_month: "Bulan Ini", filter_last_month: "Bulan Lalu",
                empty_goal_desc: "Yuk, buat tujuan pertamamu!", empty_archive_desc: "Belum ada tabungan yang diselesaikan", empty_history_desc: "Mulai menabung untuk melihat riwayat",
                notif_title: "Aktivitas Baru!"
            },
            en: {
                welcome: "Welcome,", total_balance: "Total Balance", income: "Income", outcome: "Outcome",
                savings_goal: "Saving Goals", available_balance: "Available Balance", progress: "Total Progress",
                archive_now: "Archive Now", history: "Transaction History", history_tab: "History", chat_tab: "Chat",
                withdraw: "Withdraw", save: "Save", nav_home: "Home", nav_history: "History", nav_profile: "Profile",
                archive: "Archive", archive_desc: "100% Goal Completed", dark_mode: "Dark Mode", language_name: "Language",
                language_val: "EN", edit_goal: "Edit Saving", goal_name: "Goal Name", target_nominal: "Target Amount",
                save_changes: "Save Changes", goal_reached: "Reached!", celeb_desc: "Saving", celeb_done: "is 100% completed!",
                continue: "Continue", label_depositor: "Depositor", label_note: "Note (Optional)", confirm: "Confirm",
                all: "All", in: "In", out: "Out", data_activities: "Data & Activities", app_settings: "App Settings",
                no_goals: "No goals yet", no_archive: "No archived items", empty_history: "No history yet",
                placeholder_goal: "Buy a Laptop...", install_app: "Install App",
                choose_avatar: "Choose Avatar", options: "Options", share: "Share", delete: "Delete Goal",
                share_title: "Invite Friends",
                install_ios_desc: "For iPhone/iPad users (Safari):", install_ios_step1: "Tap the Share icon at the bottom", install_ios_step2: "Select 'Add to Home Screen'",
                install_android_desc: "For Android users (Chrome):", install_android_step1: "Tap the Three Dots icon at the top", install_android_step2: "Select 'Add to Home screen'",
                install_prompt_title: "Install App", install_prompt_desc: "Faster access & easy to use", install_btn: "View Tutorial",
                login_desc: "Save your savings data securely in the cloud using your Google account.", login_google: "Sign in with Google", logout: "Log Out",
                name_warning: "*Warning: Name cannot be changed once saved. Please use your real name.",
                filter_all_time: "All Time", filter_this_month: "This Month", filter_last_month: "Last Month",
                empty_goal_desc: "Let's create your first goal!", empty_archive_desc: "No completed goals yet", empty_history_desc: "Start saving to see your history",
                notif_title: "New Activity!"
            }
        };

        // --- APP STATE ---
        let appData = JSON.parse(localStorage.getItem(DB_KEY)) || {
            user: '', email: '', uid: '',
            avatar: { emoji: '', colorClass: 'bg-indigo-100', textClass: 'text-indigo-700' },
            joinedRooms: [], darkMode: false, language: 'id', hideInstallBanner: false
        };
        let globalRooms = [];
        let globalHistory = [];
        let globalChats = []; 
        let currentRoomId = null;
        let roomToDelete = null;
        let isBalanceHidden = false;
        let currentHistoryFilter = 'all'; 
        let currentTimeFilter = 'all_time'; 
        let currentDetailTab = 'history'; 
        let isInitialHistoryLoad = true;
        let backPressedOnce = false;

        // --- BACK BUTTON LOGIC ---
        window.addEventListener('popstate', (e) => {
            const currentView = document.querySelector('main:not(.hidden)')?.id;
            if (currentView === 'view-home') {
                if (backPressedOnce) {
                    // Default browser behavior (exit app)
                } else {
                    backPressedOnce = true;
                    showToast("Tekan sekali lagi untuk keluar");
                    history.pushState(null, null, null); // Block first back press
                    setTimeout(() => backPressedOnce = false, 2000); // Reset after 2s
                }
            } else if (currentView === 'view-profile' || currentView === 'view-history') {
                window.switchView('view-home', 'nav-home');
                history.pushState(null, null, null);
            } else {
                window.historyBackOverride('view-home');
                history.pushState(null, null, null);
            }
        });
        history.pushState(null, null, null);

        // --- HELPERS ---
        window.saveLocal = () => localStorage.setItem(DB_KEY, JSON.stringify(appData));
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            if(t) { t.innerText = msg; t.classList.add('toast-visible'); setTimeout(() => t.classList.remove('toast-visible'), 2500); }
        };
        
        window.showRealtimeNotif = (msg) => {
            const notif = document.getElementById('realtime-notif');
            const textEl = document.getElementById('realtime-notif-text');
            if(notif && textEl) {
                textEl.innerText = msg;
                notif.classList.remove('-translate-y-full');
                notif.classList.add('translate-y-4');
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    osc.type = 'sine'; osc.frequency.setValueAtTime(880, ctx.currentTime);
                    osc.connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.1);
                } catch(e) {}
                setTimeout(() => { notif.classList.remove('translate-y-4'); notif.classList.add('-translate-y-full'); }, 4000);
            }
        }

        window.closeAllModals = () => {
            modalIds.forEach(id => { 
                const m = document.getElementById(id); 
                if(m) {
                    m.classList.add('translate-y-full');
                    if(id === 'modal-celebration' || id === 'modal-name-entry') m.classList.add('hidden');
                    else setTimeout(() => m.classList.add('hidden'), 300);
                }
            });
            const overlay = document.getElementById('modal-overlay'); if(overlay) overlay.classList.add('hidden');
        };

        window.showModal = (id) => {
            const overlay = document.getElementById('modal-overlay');
            const m = document.getElementById(id);
            if(id !== 'modal-celebration' && id !== 'modal-name-entry' && overlay) overlay.classList.remove('hidden');
            if(m) {
                m.classList.remove('hidden');
                setTimeout(() => m.classList.remove('translate-y-full'), 10);
            }
        };
        
        const createSpinner = () => `<svg class="spinner" viewBox="0 0 50 50"><circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle></svg>`;

        function applyTranslations() {
            const lang = i18n[appData.language];
            document.querySelectorAll('[data-t]').forEach(el => {
                const key = el.getAttribute('data-t');
                if (lang[key]) el.innerText = lang[key];
            });
            const langDisp = document.getElementById('lang-display');
            if (langDisp) langDisp.innerText = appData.language.toUpperCase();
            
            const createNameInp = document.getElementById('create-name');
            if(createNameInp) createNameInp.placeholder = lang.placeholder_goal;

            const monthStr = new Date().toLocaleString(appData.language === 'id' ? 'id-ID' : 'en-US', { month: 'short' });
            const lblIn = document.getElementById('label-income');
            if (lblIn) lblIn.innerText = `${lang.income} (${monthStr})`;
            const lblOut = document.getElementById('label-outcome');
            if (lblOut) lblOut.innerText = `${lang.outcome} (${monthStr})`;
        }
        window.applyTranslations = applyTranslations;

        window.toggleLanguage = () => {
            appData.language = appData.language === 'id' ? 'en' : 'id';
            window.saveLocal();
            applyTranslations();
            updateUI();
            window.showToast(appData.language === 'id' ? "Bahasa diubah" : "Language changed");
        };

        window.toggleDarkMode = () => {
            const toggle = document.getElementById('toggle-dark');
            if (!toggle) return;
            appData.darkMode = toggle.checked;
            window.saveLocal();
            if (appData.darkMode) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        };

        async function syncJoinedRoomsToCloud() {
            if(appData.uid) {
                try { await updateDoc(doc(db, "users", appData.uid), { joinedRooms: appData.joinedRooms }); } catch(e) {}
            }
        }

        async function joinRoom(roomId) {
            if(!appData.joinedRooms.includes(roomId)) {
                appData.joinedRooms.push(roomId);
                window.saveLocal();
            }
            if(appData.uid) {
                try { await updateDoc(doc(db, "users", appData.uid), { joinedRooms: appData.joinedRooms }); } catch(e) {}
                try { await updateDoc(doc(db, "rooms", roomId), { [`membersMap.${appData.uid}`]: { name: appData.user, avatar: appData.avatar } }); } catch(e) {}
            }
        }

        const splashStartTime = Date.now();
        const MIN_SPLASH_TIME = 1800;

        onAuthStateChanged(auth, async (user) => {
            const modalLogin = document.getElementById('modal-onboarding');
            const modalName = document.getElementById('modal-name-entry');
            const viewHome = document.getElementById('view-home');
            const bottomNav = document.getElementById('bottom-nav');
            const splashScreen = document.getElementById('splash-screen');

            const hideSplash = (callback) => {
                const elapsed = Date.now() - splashStartTime;
                const delay = Math.max(0, MIN_SPLASH_TIME - elapsed);
                setTimeout(() => {
                    if (splashScreen && !splashScreen.classList.contains('hidden')) {
                        splashScreen.classList.add('opacity-0');
                        setTimeout(() => {
                            splashScreen.classList.add('hidden');
                            if (callback) callback();
                        }, 700);
                    } else if (callback) callback();
                }, delay);
            };

            if (user) {
                appData.email = user.email;
                appData.uid = user.uid;
                window.saveLocal();
                if (modalLogin) modalLogin.classList.add('hidden');

                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userDocRef);

                    if (userSnap.exists()) {
                        const cloudData = userSnap.data();
                        appData.user = cloudData.name || user.displayName || 'Pengguna';
                        if (cloudData.avatar) appData.avatar = cloudData.avatar;
                        
                        const urlParams = new URLSearchParams(window.location.search);
                        const sharedId = urlParams.get('id');
                        if(sharedId) await joinRoom(sharedId);

                        if (cloudData.joinedRooms) {
                            appData.joinedRooms = [...new Set([...appData.joinedRooms, ...cloudData.joinedRooms])];
                        }
                        
                        window.saveLocal();
                        startRealtimeSync();
                        updateUI();

                        hideSplash(() => {
                            if (modalName) modalName.classList.add('hidden');
                            if (viewHome) viewHome.classList.remove('hidden');
                            if (bottomNav) bottomNav.classList.remove('hidden');
                        });
                    } else {
                        hideSplash(() => {
                            if (modalName) {
                                modalName.classList.remove('hidden');
                                setTimeout(() => modalName.classList.remove('opacity-0'), 50);
                                const nameInput = document.getElementById('onboarding-name');
                                if (nameInput && !nameInput.value && user.displayName) nameInput.value = user.displayName;
                            }
                        });
                    }
                } catch (error) { hideSplash(); }
            } else {
                hideSplash(() => {
                    if (modalLogin) {
                        modalLogin.classList.remove('hidden');
                        setTimeout(() => modalLogin.classList.remove('opacity-0'), 50);
                    }
                    if (modalName) modalName.classList.add('hidden');
                    if (viewHome) viewHome.classList.add('hidden');
                    if (bottomNav) bottomNav.classList.add('hidden');
                });
            }
        });

        window.loginWithGoogle = async () => {
            const btn = document.getElementById('btn-google-login');
            btn.disabled = true; 
            btn.innerHTML = createSpinner() + ' ...';
            try {
                await signInWithPopup(auth, new GoogleAuthProvider());
                window.showToast("Autentikasi berhasil!");
            } catch (error) {
                if(error.code !== 'auth/popup-closed-by-user') alert("Gagal login: " + error.message);
                btn.disabled = false;
                btn.innerHTML = `<svg viewBox="0 0 24 24" class="w-6 h-6"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path fill="none" d="M1 1h22v22H1z"/></svg> <span data-t="login_google">${i18n[appData.language].login_google}</span>`;
            }
        };

        window.saveOnboardingName = async () => {
            const btn = document.getElementById('btn-save-name');
            const nameEl = document.getElementById('onboarding-name');
            if(!nameEl) return;
            const name = nameEl.value.trim();
            if(!/^[a-zA-Z\s]+$/.test(name)) return alert("Nama hanya boleh berisi huruf.");
            if(name.length < 3) return alert("Nama terlalu pendek.");
            
            btn.disabled = true; 
            btn.innerHTML = createSpinner() + ' ...';
            
            appData.user = name; 
            window.saveLocal();

            try {
                await setDoc(doc(db, "users", appData.uid), {
                    name: appData.user, email: appData.email, avatar: appData.avatar, joinedRooms: appData.joinedRooms, createdAt: Date.now()
                });
                const urlParams = new URLSearchParams(window.location.search);
                const sharedId = urlParams.get('id');
                if(sharedId) await joinRoom(sharedId);
            } catch(e) { }
            
            document.getElementById('modal-name-entry').classList.add('hidden');
            const viewHome = document.getElementById('view-home');
            const bottomNav = document.getElementById('bottom-nav');
            if(viewHome) viewHome.classList.remove('hidden');
            if(bottomNav) bottomNav.classList.remove('hidden');

            startRealtimeSync();
            updateUI();
        };

        window.logoutGoogle = async () => {
            if(!confirm("Keluar dari akun?")) return;
            try {
                await signOut(auth);
                appData.user = ''; appData.email = ''; appData.uid = ''; appData.joinedRooms = []; 
                window.saveLocal(); location.reload(); 
            } catch (error) { alert("Gagal keluar."); }
        };

        function startRealtimeSync() {
            onSnapshot(collection(db, "rooms"), (snap) => {
                globalRooms = snap.docs.map(d => d.data()).filter(r => appData.joinedRooms.includes(r.id)).sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                updateUI(); if(currentRoomId) refreshRoomUI(currentRoomId);
            });
            onSnapshot(collection(db, "history"), (snap) => {
                let hasNewAdded = false; let latestTx = null;
                snap.docChanges().forEach((change) => {
                    if (change.type === "added") { hasNewAdded = true; latestTx = change.doc.data(); }
                });

                globalHistory = snap.docs.map(d => d.data()).filter(h => appData.joinedRooms.includes(h.roomId)).sort((a,b) => b.timestamp - a.timestamp);
                updateUI(); if(currentRoomId) refreshRoomUI(currentRoomId);

                // Push Notifikasi In-App (Hanya untuk transaksi milik teman)
                if (!isInitialHistoryLoad && hasNewAdded && latestTx) {
                    if (appData.joinedRooms.includes(latestTx.roomId) && latestTx.userName !== appData.user) {
                        const v = appData.language === 'id' ? (latestTx.type === 'in' ? 'menabung' : 'menarik') : (latestTx.type === 'in' ? 'added' : 'withdrew');
                        window.showRealtimeNotif(` ${latestTx.userName} ${v} Rp ${latestTx.amount.toLocaleString('id-ID')} di ${latestTx.roomName}`);
                    }
                }
            });
            onSnapshot(collection(db, "chats"), (snap) => {
                globalChats = snap.docs.map(d => d.data()).filter(c => appData.joinedRooms.includes(c.roomId)).sort((a,b) => a.timestamp - b.timestamp);
                if(currentRoomId && currentDetailTab === 'chat') refreshChatUI();
            });
            setTimeout(() => { isInitialHistoryLoad = false; }, 2500);
        }

        window.handleCreateRoom = async () => {
            const name = document.getElementById('create-name').value.trim();
            if(!name) return;
            const btn = document.getElementById('btn-save-room'); btn.disabled = true;
            const id = 'room_' + Date.now();
            const r = { id, name, balance: 0, membersMap: { [appData.uid]: { name: appData.user, avatar: appData.avatar } }, createdAt: new Date().toISOString() };
            try { await setDoc(doc(db, "rooms", id), r); await joinRoom(id); window.switchView('view-home', 'nav-home'); } finally { btn.disabled = false; }
        };

        window.handleTransactionSubmit = async () => {
            const amountInput = document.getElementById('trx-amount');
            const amount = parseInt(amountInput.value.replace(/\D/g, ''));
            const r = globalRooms.find(x => x.id === currentRoomId);
            if(!amount || !r) return;
            const type = document.getElementById('trx-type').value;
            const newBal = type === 'in' ? r.balance + amount : r.balance - amount;
            if(newBal < 0) return alert("Saldo kurang");
            
            const btn = document.getElementById('btn-submit-trx'); btn.disabled = true;
            const txId = 'tx_' + Date.now();
            try {
                await updateDoc(doc(db, "rooms", currentRoomId), { balance: newBal });
                await setDoc(doc(db, "history", txId), { id: txId, roomId: currentRoomId, roomName: r.name, type, amount, userName: appData.user, timestamp: Date.now(), date: new Date().toLocaleString('id-ID', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'}), reactions: {} });
                window.closeAllModals();
            } catch(e) {} finally { btn.disabled = false; }
        };

        window.handleSendChat = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input'); const text = input.value.trim();
            if(!text) return; input.value = '';
            const id = 'msg_' + Date.now();
            await setDoc(doc(db, "chats", id), { id, roomId: currentRoomId, uid: appData.uid, userName: appData.user, avatar: appData.avatar, text, timestamp: Date.now(), date: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}) });
        };

        function refreshChatUI() {
            const list = document.getElementById('chat-list'); if(!list) return;
            const chats = globalChats.filter(c => c.roomId === currentRoomId);
            list.innerHTML = chats.map(c => {
                const isMe = c.uid === appData.uid;
                return isMe ? `<div class="flex flex-col items-end mb-1"><div class="chat-bubble-me py-2 px-4 text-sm font-medium shadow-sm break-words max-w-[80%]">${c.text}</div><span class="text-[8px] font-bold text-slate-400 mt-1">${c.date}</span></div>`
                : `<div class="flex items-end gap-2 mb-1 text-left"><div class="w-6 h-6 rounded-full shrink-0 flex items-center justify-center text-[10px] font-black ${c.avatar.colorClass}">${c.avatar.emoji || c.userName[0]}</div><div class="flex flex-col items-start"><p class="text-[8px] font-bold text-slate-400 ml-1 mb-0.5">${c.userName}</p><div class="chat-bubble-other py-2 px-4 text-sm font-medium shadow-sm text-left break-words max-w-[80%]">${c.text}</div><span class="text-[8px] font-bold text-slate-400 mt-1 ml-1">${c.date}</span></div></div>`;
            }).join('') || `<p class="text-center opacity-40 text-xs">Belum ada obrolan</p>`;
            const container = document.getElementById('tab-content-chat'); if(container) container.scrollTop = container.scrollHeight;
            lucide.createIcons();
        }

        window.toggleReaction = async (txId, emoji, btnElement) => {
            if(btnElement) btnElement.classList.add('reaction-pop');
            setTimeout(() => { if(btnElement) btnElement.classList.remove('reaction-pop'); }, 300);

            const tx = globalHistory.find(h => h.id === txId);
            if(!tx) return;
            let currentRx = tx.reactions || {};
            if(currentRx[appData.uid] === emoji) delete currentRx[appData.uid];
            else currentRx[appData.uid] = emoji;
            try { await updateDoc(doc(db, "history", txId), { reactions: currentRx }); } catch(e) {}
        };

        window.openRoomDetail = (id) => { currentRoomId = id; window.switchDetailTab('history'); refreshRoomUI(id); window.switchView('view-detail'); };

        function refreshRoomUI(id) {
            const lang = i18n[appData.language];
            const r = globalRooms.find(x => x.id === id); if(!r) return;
            document.getElementById('detail-title').innerText = r.name;
            document.getElementById('detail-balance').innerText = 'Rp ' + r.balance.toLocaleString('id-ID');

            const pile = document.getElementById('detail-member-pile');
            if(pile && r.membersMap) pile.innerHTML = Object.values(r.membersMap).map(m => `<div class="w-7 h-7 rounded-full border-2 border-white dark:border-slate-900 flex items-center justify-center text-[10px] font-black shadow-sm ${m.avatar.colorClass}">${m.avatar.emoji || m.name[0]}</div>`).join('');
            
            const tgtBox = document.getElementById('detail-target-container');
            if(r.hasTarget) {
                tgtBox.classList.remove('hidden');
                const pct = Math.min(Math.round((r.balance/r.target)*100), 100);
                document.getElementById('detail-progress-text').innerText = `${r.balance.toLocaleString('id-ID')} / ${r.target.toLocaleString('id-ID')}`;
                document.getElementById('detail-progress-bar').style.width = pct + '%';
            } else tgtBox.classList.add('hidden');
            
            const histList = document.getElementById('detail-history-list');
            const filtered = globalHistory.filter(h => h.roomId === id);
            
            // Render riwayat dan cegah diklik (hanya dilihat)
            histList.innerHTML = filtered.map(h => {
                const isIn = h.type === 'in';
                const noteHtml = h.note ? `<p class="text-[10px] text-slate-500 italic mt-1 truncate max-w-[150px]">"${h.note}"</p>` : '';
                let rxFire = 0, rxClap = 0, rxHeart = 0; let myRx = null;
                if(h.reactions) {
                    Object.values(h.reactions).forEach(em => { if(em === '') rxFire++; if(em === '') rxClap++; if(em === '') rxHeart++; });
                    myRx = h.reactions[appData.uid];
                }
                const btnClass = "text-[9px] font-black px-2 py-1 rounded-full border transition-colors active:scale-90 flex items-center gap-1 cursor-pointer";
                return `<div class="relative pl-8 mb-6 cursor-default"><span class="absolute -left-[20px] top-1 ${isIn?'bg-emerald-100 text-emerald-600':'bg-rose-100 text-rose-600'} p-1.5 rounded-full border-4 border-white dark:border-slate-950"><i data-lucide="${isIn?'arrow-down':'arrow-up'}" class="w-3.5 h-3.5"></i></span><div class="flex justify-between items-start"><div class="flex-1 pr-2"><p class="text-sm font-black dark:text-white">${h.userName}</p><p class="text-[9px] font-bold text-slate-400">${h.date}</p>${noteHtml}</div><p class="text-sm font-black ${isIn?'text-emerald-600':'text-rose-600'}">Rp ${h.amount.toLocaleString('id-ID')}</p></div><div class="flex gap-1.5 mt-2"><button onclick="window.toggleReaction('${h.id}', '', this)" class="${btnClass} ${myRx===''?'bg-orange-100 border-orange-200 text-orange-700':'bg-slate-50 dark:bg-slate-800 border-transparent text-slate-500'}"> ${rxFire||''}</button><button onclick="window.toggleReaction('${h.id}', '', this)" class="${btnClass} ${myRx===''?'bg-amber-100 border-amber-200 text-amber-700':'bg-slate-50 dark:bg-slate-800 border-transparent text-slate-500'}"> ${rxClap||''}</button><button onclick="window.toggleReaction('${h.id}', '', this)" class="${btnClass} ${myRx===''?'bg-rose-100 border-rose-200 text-rose-700':'bg-slate-50 dark:bg-slate-800 border-transparent text-slate-500'}"> ${rxHeart||''}</button></div></div>`
            }).join('') || `<div class="text-center py-10 opacity-40"><i data-lucide="hourglass" class="w-10 h-10 mx-auto mb-3 text-slate-400"></i><p class="text-xs font-bold text-slate-400 uppercase">Belum ada riwayat</p></div>`;
            lucide.createIcons();
        }

        window.switchDetailTab = (tab) => {
            currentDetailTab = tab;
            document.getElementById('tab-content-history').classList.toggle('hidden', tab !== 'history');
            document.getElementById('tab-content-chat').classList.toggle('hidden', tab !== 'chat');
            document.getElementById('action-bar-history').classList.toggle('hidden', tab !== 'history');
            document.getElementById('action-bar-chat').classList.toggle('hidden', tab !== 'chat');
            document.getElementById('tab-btn-history').className = tab === 'history' ? "flex-1 py-4 text-xs font-black text-indigo-600 border-b-2 border-indigo-600 uppercase transition-all" : "flex-1 py-4 text-xs font-bold text-slate-400 border-b-2 border-transparent uppercase transition-all";
            document.getElementById('tab-btn-chat').className = tab === 'chat' ? "flex-1 py-4 text-xs font-black text-indigo-600 border-b-2 border-indigo-600 uppercase transition-all flex items-center justify-center gap-2" : "flex-1 py-4 text-xs font-bold text-slate-400 border-b-2 border-transparent uppercase transition-all flex items-center justify-center gap-2";
            if(tab === 'chat') refreshChatUI();
        };

        window.switchView = (viewId, navId = null) => {
            ['view-home', 'view-detail', 'view-history', 'view-profile', 'view-create', 'view-archive'].forEach(v => document.getElementById(v)?.classList.add('hidden'));
            document.getElementById(viewId)?.classList.remove('hidden');
            const nav = document.getElementById('bottom-nav');
            if (['view-detail', 'view-create', 'view-archive'].includes(viewId)) nav.classList.add('hidden');
            else nav.classList.remove('hidden');
            if(navId) {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.replace('text-indigo-600', 'text-slate-300');
                    btn.querySelector('span')?.classList.replace('font-black', 'font-bold');
                });
                const active = document.getElementById(navId);
                if(active) {
                    active.classList.replace('text-slate-300', 'text-indigo-600');
                    active.querySelector('span')?.classList.replace('font-bold', 'font-black');
                }
            }
            window.scrollTo(0,0);
        };

        window.historyBackOverride = (fallback) => window.switchView(fallback, 'nav-' + fallback.split('-')[1]);

        window.filterHistory = (type) => {
            currentHistoryFilter = type;
            ['all', 'in', 'out'].forEach(f => {
                const btn = document.getElementById('filter-'+f);
                if(!btn) return;
                if(f === type) {
                    btn.classList.add('bg-slate-900', 'text-white', 'dark:bg-indigo-600');
                    btn.classList.remove('bg-slate-100', 'text-slate-600', 'dark:bg-slate-800', 'dark:text-slate-400');
                } else {
                    btn.classList.remove('bg-slate-900', 'text-white', 'dark:bg-indigo-600');
                    btn.classList.add('bg-slate-100', 'text-slate-600', 'dark:bg-slate-800', 'dark:text-slate-400');
                }
            });
            updateUI();
        };

        window.changeTimeFilter = (val) => { currentTimeFilter = val; updateUI(); }

        function updateUI() {
            if(!appData.user) return;
            const lang = i18n[appData.language];
            ['home-avatar', 'profile-avatar'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.className = `w-${id.includes('profile')?24:12} h-${id.includes('profile')?24:12} rounded-full flex items-center justify-center text-${id.includes('profile')?'5xl':'xl'} font-black shadow-inner border border-black/5 dark:border-white/5 ${appData.avatar.colorClass} ${appData.avatar.textClass}`; el.innerText = appData.avatar.emoji || appData.user[0].toUpperCase(); }
            });

            document.getElementById('home-username').innerText = appData.user;
            document.getElementById('profile-username').innerText = appData.user;
            document.getElementById('profile-email').innerText = appData.email || '';

            const active = globalRooms.filter(r => !r.isArchived);
            const total = active.reduce((acc, r) => acc + r.balance, 0);
            const totalEl = document.getElementById('total-balance');
            if(totalEl) {
                totalEl.setAttribute('data-value', total);
                totalEl.innerText = isBalanceHidden ? 'Rp *********' : 'Rp ' + total.toLocaleString('id-ID');
            }

            // DANA Style Feed (Not Truncated)
            const feed = document.getElementById('home-updates-feed');
            if(feed) {
                feed.innerHTML = '';
                const items = globalHistory.slice(0, 10);
                if(items.length === 0) feed.innerHTML = `<p class="text-[10px] text-slate-400 italic text-left">Belum ada aktivitas terbaru...</p>`;
                else {
                    feed.innerHTML = items.map(h => {
                        const verb = appData.language === 'id' ? (h.type === 'in' ? 'menabung' : 'menarik') : (h.type === 'in' ? 'added' : 'withdrew');
                        return `
                        <div class="flex items-start gap-3 pb-3 border-b border-slate-50 dark:border-slate-800/50 last:border-0 last:pb-0 cursor-pointer active:scale-95 transition-transform text-left" onclick="window.openRoomDetail('${h.roomId}')">
                            <div class="w-7 h-7 rounded-full ${h.type==='in'?'bg-emerald-50 text-emerald-600':'bg-rose-50 text-rose-600'} flex items-center justify-center shrink-0 text-[10px] font-black border border-white dark:border-slate-800 mt-0.5">${h.userName[0].toUpperCase()}</div>
                            <div class="flex-1">
                                <p class="text-[11px] font-medium text-slate-600 dark:text-slate-300 leading-snug break-words">
                                    <span class="font-black text-slate-900 dark:text-white">${h.userName}</span> 
                                    ${verb} 
                                    <span class="font-black text-indigo-600 dark:text-indigo-400">Rp ${h.amount.toLocaleString('id-ID')}</span> 
                                    di ${h.roomName}
                                </p>
                                <p class="text-[9px] font-bold text-slate-400 mt-0.5">${h.date.split(',')[0]}</p>
                            </div>
                        </div>`;
                    }).join('');
                }
            }

            const container = document.getElementById('rooms-container');
            container.innerHTML = active.map(r => `<div class="bg-white dark:bg-slate-900 p-6 rounded-[2.5rem] border border-slate-100 dark:border-slate-800 shadow-sm active:scale-[0.98] transition-all cursor-pointer text-left" onclick="window.openRoomDetail('${r.id}')"><div class="flex justify-between items-start mb-6"><div class="flex items-center gap-4"><div class="w-12 h-12 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 flex items-center justify-center rounded-2xl"><i data-lucide="target"></i></div><h3 class="font-black text-slate-800 dark:text-white text-lg">${r.name}</h3></div><button onclick="event.stopPropagation(); window.openManageModal('${r.id}')" class="text-slate-300 p-2"><i data-lucide="more-vertical"></i></button></div><div class="flex justify-between items-end"><div><p class="text-[9px] font-black text-slate-400 uppercase mb-1">Terkumpul</p><p class="text-2xl font-black dark:text-white">Rp ${r.balance.toLocaleString('id-ID')}</p></div></div></div>`).join('') || `<div class="text-center py-10 opacity-40"><p class="text-xs font-bold uppercase tracking-widest">${lang.no_goals}</p></div>`;
            
            const gHist = document.getElementById('global-history-container');
            let filteredGHist = globalHistory;
            if(currentHistoryFilter !== 'all') filteredGHist = filteredGHist.filter(h => h.type === currentHistoryFilter);
            
            const now = new Date();
            if(currentTimeFilter === 'this_month') {
                filteredGHist = filteredGHist.filter(h => { const d = new Date(h.timestamp); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); });
            } else if(currentTimeFilter === 'last_month') {
                filteredGHist = filteredGHist.filter(h => { const d = new Date(h.timestamp); let lm = now.getMonth() - 1; let ly = now.getFullYear(); if(lm < 0) { lm = 11; ly--; } return d.getMonth() === lm && d.getFullYear() === ly; });
            }

            // Global History (Non-clickable, view only)
            gHist.innerHTML = filteredGHist.map(h => `<div class="flex justify-between items-center p-5 bg-white dark:bg-slate-900 rounded-[2rem] border border-slate-50 dark:border-slate-800 shadow-sm text-left"><div class="flex items-center gap-4 flex-1 overflow-hidden"><div class="w-10 h-10 rounded-xl ${h.type==='in'?'bg-emerald-50 text-emerald-600':'bg-rose-50 text-rose-600'} flex items-center justify-center shrink-0"><i data-lucide="${h.type==='in'?'arrow-down':'arrow-up'}" class="w-5 h-5"></i></div><div class="overflow-hidden flex-1 text-left"><p class="text-sm font-black dark:text-white truncate">${h.roomName}</p><p class="text-[9px] font-bold text-slate-400 uppercase truncate">${h.userName}  ${h.date.split(',')[0]}</p></div></div><p class="text-sm font-black shrink-0 ${h.type==='in'?'text-emerald-600':'text-rose-600'} ml-2">Rp ${h.amount.toLocaleString('id-ID')}</p></div>`).join('') || `<div class="text-center py-20 opacity-40"><i data-lucide="scroll" class="w-10 h-10 mx-auto mb-3 text-slate-400"></i><p class="text-[10px] font-bold uppercase tracking-widest text-slate-600 dark:text-slate-300">Belum ada riwayat</p></div>`;
            
            let mIn = 0, mOut = 0;
            globalHistory.forEach(h => {
                const d = new Date(h.timestamp);
                if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) { if(h.type === 'in') mIn += h.amount; else mOut += h.amount; }
            });
            document.getElementById('mutasi-in').innerText = isBalanceHidden ? 'Rp ***' : 'Rp ' + mIn.toLocaleString('id-ID');
            document.getElementById('mutasi-out').innerText = isBalanceHidden ? 'Rp ***' : 'Rp ' + mOut.toLocaleString('id-ID');
            lucide.createIcons(); applyTranslations();
        }

        window.toggleBalance = () => { isBalanceHidden = !isBalanceHidden; updateUI(); };
        window.openAvatarModal = () => window.showModal('modal-avatar');
        window.saveAvatarSelection = async () => { window.saveLocal(); updateUI(); window.closeAllModals(); if(appData.uid) await updateDoc(doc(db, "users", appData.uid), { avatar: appData.avatar }); };

        window.onload = () => {
            const colorDiv = document.getElementById('color-options');
            if (colorDiv) {
                const COLORS = [{bg:'bg-indigo-100', txt:'text-indigo-700'}, {bg:'bg-rose-100', txt:'text-rose-700'}, {bg:'bg-emerald-100', txt:'text-emerald-700'}, {bg:'bg-amber-100', txt:'text-amber-700'}, {bg:'bg-purple-100', txt:'text-purple-700'}, {bg:'bg-slate-200', txt:'text-slate-700'}, {bg:'bg-sky-100', txt:'text-sky-700'}, {bg:'bg-fuchsia-100', txt:'text-fuchsia-700'}];
                COLORS.forEach(c => {
                    const b = document.createElement('button'); b.className = `color-btn w-14 h-14 rounded-full border-4 ${c.bg} shrink-0 transition-all active:scale-90`;
                    b.onclick = () => { document.querySelectorAll('#color-options button').forEach(x => x.classList.remove('selected')); b.classList.add('selected'); appData.avatar.colorClass = c.bg; appData.avatar.textClass = c.txt; };
                    if(appData.avatar.colorClass === c.bg) b.classList.add('selected'); colorDiv.appendChild(b);
                });
            }
            const emojiDiv = document.getElementById('emoji-options');
            if (emojiDiv) {
                const EMOJIS = ['', '', '', '', 'Rex', '', '', 'Alien', 'Sushi', 'Burger', 'Pizza', 'Ramen', 'Fries', 'Ice', 'Donut', 'Coffee', '', '', 'Bot', '', 'Ghost', 'Rocket', 'Guitar', 'Ball'];
                EMOJIS.forEach(e => {
                    const b = document.createElement('button'); b.className = `emoji-btn p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl text-2xl border-2 border-transparent active:scale-90 flex items-center justify-center`;
                    b.innerText = e;
                    b.onclick = () => { document.querySelectorAll('#emoji-options button').forEach(x => x.classList.remove('selected')); b.classList.add('selected'); appData.avatar.emoji = e; };
                    if(e === appData.avatar.emoji) b.classList.add('selected'); emojiDiv.appendChild(b);
                });
            }
            document.querySelectorAll('.money-input').forEach(input => input.addEventListener('input', function() { const val = this.value.replace(/\D/g, ''); this.value = val ? parseInt(val).toLocaleString('id-ID') : ''; }));
        };

        window.openInstallModal = () => {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            const container = document.getElementById('install-instructions');
            const lang = i18n[appData.language];
            if(isIOS) {
                container.innerHTML = `<p class="text-sm text-slate-500 mb-3">${lang.install_ios_desc}</p><div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl mb-2 flex items-center gap-3 text-left"><i data-lucide="share" class="text-indigo-500"></i><p class="text-sm font-black">1. ${lang.install_ios_step1}</p></div><div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl flex items-center gap-3 text-left"><i data-lucide="plus-square" class="text-indigo-500"></i><p class="text-sm font-black">2. ${lang.install_ios_step2}</p></div>`;
            } else {
                container.innerHTML = `<p class="text-sm text-slate-500 mb-3">${lang.install_android_desc}</p><div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl mb-2 flex items-center gap-3 text-left"><i data-lucide="more-vertical" class="text-indigo-500"></i><p class="text-sm font-black">1. ${lang.install_android_step1}</p></div><div class="p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl flex items-center gap-3 text-left"><i data-lucide="download" class="text-indigo-500"></i><p class="text-sm font-black">2. ${lang.install_android_step2}</p></div>`;
            }
            lucide.createIcons(); showModal('modal-install');
        };
        window.openTransactionModal = (type) => { document.getElementById('trx-amount').value = ''; document.getElementById('trx-type').value = type === 'nabung' ? 'in' : 'out'; document.getElementById('trx-title').innerText = type === 'nabung' ? i18n[appData.language].save : i18n[appData.language].withdraw; document.getElementById('trx-user-display').value = appData.user; document.getElementById('trx-note').value = ''; showModal('modal-transaction'); };
        window.openEditModal = () => { const r = globalRooms.find(x => x.id === currentRoomId); if(r) { document.getElementById('edit-name').value = r.name; document.getElementById('edit-target').value = r.target ? r.target.toLocaleString('id-ID') : ''; showModal('modal-edit'); } };
        window.openShareOptions = () => { const link = window.location.origin + window.location.pathname + "?id=" + roomToDelete; document.getElementById('share-link-text').innerText = link; showModal('modal-share'); };
        window.copyShareLink = () => { const text = document.getElementById('share-link-text').innerText; const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); window.showToast("Berhasil disalin!"); };
        window.openManageModal = (id) => { roomToDelete = id; showModal('modal-manage'); };
        window.dismissInstallBanner = () => { appData.hideInstallBanner = true; window.saveLocal(); document.getElementById('install-banner').classList.add('hidden'); };
    </script>
</body>
</html>
